"use strict";(()=>{var a={};a.id=531,a.ids=[531],a.modules={3939:a=>{a.exports=require("@supabase/supabase-js")},5600:a=>{a.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},7834:(a,b,c)=>{c.r(b),c.d(b,{config:()=>u,default:()=>t,handler:()=>w});var d={};c.r(d),c.d(d,{default:()=>q});var e=c(9046),f=c(8667),g=c(3480),h=c(6435);let i="https://api.retellai.com",j="key_c64dab86009c916934d315eb28a6";async function k(a){let b=await fetch(a,{headers:{Authorization:`Bearer ${j}`,"Content-Type":"application/json"}});if(!b.ok){let c=await b.text();throw Error(`${a} failed: ${b.status} ${c}`)}return b.json()}async function l(a){let b=await k(`${i}/get-retell-llm/${a}`);return b.prompt||b.general_prompt||b.system_prompt||b.llm&&(b.llm.prompt||b.llm.general_prompt)||""}let m={async startCall({agentExternalId:a,toPhoneE164:b,metadata:c}){let d=await fetch(`${i}/create-phone-call`,{method:"POST",headers:{Authorization:`Bearer ${j}`,"Content-Type":"application/json"},body:JSON.stringify({agent_id:a,from_number:process.env.RETELL_PHONE_NUMBER,to_number:b,metadata:c})});if(!d.ok)throw Error(`startCall failed: ${d.status} ${await d.text()}`);return{externalCallId:(await d.json()).call_id}},async stopCall(a){let b=await fetch(`${i}/delete-call/${a}`,{method:"DELETE",headers:{Authorization:`Bearer ${j}`}});b.ok||console.error("Failed to stop call",await b.text())},async getAgentPrompt(a){let b=await k(`${i}/get-agent/${a}`),c=b?.response_engine?.llm_id;if(!c)return console.warn("⚠️ No LLM linked with this agent:",b),"";let d=await l(c);return d||console.warn("⚠️ Prompt empty for LLM:",c,"agent:",b),d},async importAgent(a){let b=await k(`${i}/get-agent/${a}`),c=b?.response_engine?.llm_id,d=c?await l(c):"";return{name:b.agent_name??b.name??a,prompt:d,config:b}}},n="https://api.vapi.ai/v1",o={async startCall({agentExternalId:a,toPhoneE164:b,metadata:c}){let d=await fetch(`${n}/calls`,{method:"POST",headers:{Authorization:`Bearer ${process.env.VAPI_API_KEY}`,"Content-Type":"application/json"},body:JSON.stringify({agent_id:a,to:b,metadata:c})});if(!d.ok)throw Error(`VAPI startCall failed: ${d.statusText}`);return{externalCallId:(await d.json()).id}},async stopCall(a){await fetch(`${n}/calls/${a}/stop`,{method:"POST",headers:{Authorization:`Bearer ${process.env.VAPI_API_KEY}`}})},async getAgentPrompt(a){let b=await fetch(`${n}/agents/${a}`,{headers:{Authorization:`Bearer ${process.env.VAPI_API_KEY}`}});return(await b.json()).prompt??""},async importAgent(a){let b=await fetch(`${n}/agents/${a}`,{headers:{Authorization:`Bearer ${process.env.VAPI_API_KEY}`}}),c=await b.json();return{name:c.name,prompt:c.prompt,config:c}}},p=(0,c(3939).createClient)("https://oocueuyucxahfeyijikr.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9vY3VldXl1Y3hhaGZleWlqaWtyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA4OTI2NTgsImV4cCI6MjA3NjQ2ODY1OH0.tWAzcnjSi-RoN3Tca8UjSqLKgkMT3NwBOyv46btg-6I");async function q(a,b){if("POST"!==a.method)return b.status(405).json({error:"Method not allowed"});try{let{agentId:c,contactId:d}=a.body,{data:e,error:f}=await p.from("agents").select("id, provider, external_agent_id, is_active").eq("id",c).single();if(f||!e||!e.is_active)return b.status(404).json({error:"Agent not found or inactive"});let{data:g,error:h}=await p.from("contacts").select("id, phone_e164, first_name, last_name").eq("id",d).single();if(h||!g)return b.status(404).json({error:"Contact not found"});let{data:i}=await p.from("do_not_call").select("phone_e164").eq("phone_e164",g.phone_e164).single();if(i)return b.status(400).json({error:"Contact is on DNC list"});let j=function(a){switch(a){case"retell":return m;case"vapi":return o;default:throw Error(`Unsupported provider: ${a}`)}}(e.provider),k=await j.startCall({agentExternalId:e.external_agent_id,toPhoneE164:g.phone_e164,metadata:{contact_id:d,first_name:g.first_name||"",last_name:g.last_name||""}}),{data:l,error:n}=await p.from("call_runs").insert({external_call_id:k.externalCallId,agent_id:c,contact_id:d,provider:e.provider,direction:"outbound",status:"initiated",started_at:new Date().toISOString()}).select().single();if(n)throw n;return b.status(200).json({callRunId:l.id,externalCallId:k.externalCallId,status:"initiated"})}catch(a){return console.error("Start call error:",a),b.status(500).json({error:a instanceof Error?a.message:"Internal server error"})}}var r=c(8112),s=c(8766);let t=(0,h.M)(d,"default"),u=(0,h.M)(d,"config"),v=new g.PagesAPIRouteModule({definition:{kind:f.A.PAGES_API,page:"/api/calls/start",pathname:"/api/calls/start",bundlePath:"",filename:""},userland:d,distDir:".next",relativeProjectDir:""});async function w(a,b,c){let d=await v.prepare(a,b,{srcPage:"/api/calls/start"});if(!d){b.statusCode=400,b.end("Bad Request"),null==c.waitUntil||c.waitUntil.call(c,Promise.resolve());return}let{query:f,params:g,prerenderManifest:h,routerServerContext:i}=d;try{let c=a.method||"GET",d=(0,r.getTracer)(),e=d.getActiveScopeSpan(),j=v.instrumentationOnRequestError.bind(v),k=async e=>v.render(a,b,{query:{...f,...g},params:g,allowedRevalidateHeaderKeys:[],multiZoneDraftMode:!1,trustHostHeader:!1,previewProps:h.preview,propagateError:!1,dev:v.isDev,page:"/api/calls/start",internalRevalidate:null==i?void 0:i.revalidate,onError:(...b)=>j(a,...b)}).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":b.statusCode,"next.rsc":!1});let f=d.getRootSpanAttributes();if(!f)return;if(f.get("next.span_type")!==s.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${f.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let g=f.get("next.route");if(g){let a=`${c} ${g}`;e.setAttributes({"next.route":g,"http.route":g,"next.span_name":a}),e.updateName(a)}else e.updateName(`${c} ${a.url}`)});e?await k(e):await d.withPropagatedContext(a.headers,()=>d.trace(s.BaseServerSpan.handleRequest,{spanName:`${c} ${a.url}`,kind:r.SpanKind.SERVER,attributes:{"http.method":c,"http.target":a.url}},k))}catch(a){if(v.isDev)throw a;(0,e.sendError)(b,500,"Internal Server Error")}finally{null==c.waitUntil||c.waitUntil.call(c,Promise.resolve())}}}};var b=require("../../../webpack-api-runtime.js");b.C(a);var c=b.X(0,[169],()=>b(b.s=7834));module.exports=c})();