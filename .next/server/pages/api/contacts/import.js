"use strict";(()=>{var a={};a.id=604,a.ids=[604],a.modules={903:(a,b,c)=>{c.a(a,async(a,d)=>{try{c.r(b),c.d(b,{config:()=>m,default:()=>k});var e=c(3939),f=c(1742),g=c(7313),h=c(9748),i=c.n(h),j=a([f,g]);[f,g]=j.then?(await j)():j;let l=(0,e.createClient)("https://oocueuyucxahfeyijikr.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9vY3VldXl1Y3hhaGZleWlqaWtyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA4OTI2NTgsImV4cCI6MjA3NjQ2ODY1OH0.tWAzcnjSi-RoN3Tca8UjSqLKgkMT3NwBOyv46btg-6I"),m={api:{bodyParser:!1}},n=async a=>new Promise((b,c)=>{(0,g.default)({}).parse(a,(a,d,e)=>{a&&c(a),b({fields:d,files:e})})});async function k(a,b){if("POST"!==a.method)return b.status(405).json({error:"Method not allowed"});try{let{files:c}=await n(a),d=Array.isArray(c.file)?c.file[0]:c.file;if(!d)return b.status(400).json({error:"No file uploaded"});let e=await i().readFile(d.filepath,"utf-8"),g=(0,f.parse)(e,{columns:!0,skip_empty_lines:!0,trim:!0}),h=null;try{let{data:a}=await l.from("import_jobs").insert({filename:d.originalFilename||"contacts.csv",status:"validating",total_rows:g.length}).select().single();h=a?.id}catch(a){console.log("Import jobs table not found, skipping job creation")}let{data:j,error:k}=await l.from("contacts").select("phone_e164");if(k)throw Error(`Failed to fetch contacts: ${k.message}`);let m=new Set(j?.map(a=>a.phone_e164).filter(Boolean)||[]),o=[],p=[],q=[];for(let[a,b]of g.entries()){let c=b.phone||b.phone_number||b.mobile||b.phone_e164||"";if(!c){p.push(`Row ${a+1}: Missing phone number`);continue}let d=function(a){let b=a.replace(/\D/g,"");return b?b.startsWith("44")?`+${b}`:b.startsWith("0")&&b.length>=10?`+44${b.slice(1)}`:`+${b}`:""}(c);if(!d||d.length<10){p.push(`Row ${a+1}: Invalid phone format - ${c}`);continue}if(m.has(d)){q.push(`Row ${a+1}: Duplicate phone skipped - ${d}`);continue}m.add(d);let e=function(a){let b=a.replace(/\D/g,"");if(b.startsWith("44")){let a=b.slice(2);return a.startsWith("7")&&10===a.length?`0${a.slice(0,5)} ${a.slice(5)}`:(a.startsWith("1")||a.startsWith("2"),`0${a}`)}return a}(d),f={first_name:b.first_name||b.firstname||b.name?.split(" ")[0]||null,last_name:b.last_name||b.lastname||b.name?.split(" ").slice(1).join(" ")||null,email:b.email||null,phone:e,phone_e164:d,tags:b.tags?b.tags.split(",").map(a=>a.trim()):[],source:b.source||"import",dedupe_hash:d,created_at:new Date().toISOString(),updated_at:new Date().toISOString(),created_by:null};o.push(f)}if(o.length>0)for(let a=0;a<o.length;a+=100){let b=o.slice(a,a+100),{error:c}=await l.from("contacts").insert(b);c&&(console.error("Batch insert error:",c),p.push(`Failed to insert batch ${a/100+1}: ${c.message}`))}h&&await l.from("import_jobs").update({status:"completed",valid_rows:o.length,error_rows:p.length}).eq("id",h);try{await i().unlink(d.filepath)}catch(a){console.log("Could not delete temp file:",a)}return b.status(200).json({success:!0,job_id:h,total:g.length,imported:o.length,skipped:q.length,failed:p.length,errors:p.slice(0,100),skipped_details:q.slice(0,50)})}catch(a){return console.error("Import error:",a),b.status(500).json({success:!1,error:a.message||"Internal server error"})}}d()}catch(a){d(a)}})},1742:a=>{a.exports=import("csv-parse/sync")},3939:a=>{a.exports=require("@supabase/supabase-js")},5600:a=>{a.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},7313:a=>{a.exports=import("formidable")},9748:a=>{a.exports=require("fs/promises")},9858:(a,b,c)=>{c.a(a,async(a,d)=>{try{c.r(b),c.d(b,{config:()=>o,default:()=>n,handler:()=>m});var e=c(9046),f=c(8667),g=c(3480),h=c(6435),i=c(903),j=c(8112),k=c(8766),l=a([i]);i=(l.then?(await l)():l)[0];let n=(0,h.M)(i,"default"),o=(0,h.M)(i,"config"),p=new g.PagesAPIRouteModule({definition:{kind:f.A.PAGES_API,page:"/api/contacts/import",pathname:"/api/contacts/import",bundlePath:"",filename:""},userland:i,distDir:".next",relativeProjectDir:""});async function m(a,b,c){let d=await p.prepare(a,b,{srcPage:"/api/contacts/import"});if(!d){b.statusCode=400,b.end("Bad Request"),null==c.waitUntil||c.waitUntil.call(c,Promise.resolve());return}let{query:f,params:g,prerenderManifest:h,routerServerContext:i}=d;try{let c=a.method||"GET",d=(0,j.getTracer)(),e=d.getActiveScopeSpan(),l=p.instrumentationOnRequestError.bind(p),m=async e=>p.render(a,b,{query:{...f,...g},params:g,allowedRevalidateHeaderKeys:[],multiZoneDraftMode:!1,trustHostHeader:!1,previewProps:h.preview,propagateError:!1,dev:p.isDev,page:"/api/contacts/import",internalRevalidate:null==i?void 0:i.revalidate,onError:(...b)=>l(a,...b)}).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":b.statusCode,"next.rsc":!1});let f=d.getRootSpanAttributes();if(!f)return;if(f.get("next.span_type")!==k.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${f.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let g=f.get("next.route");if(g){let a=`${c} ${g}`;e.setAttributes({"next.route":g,"http.route":g,"next.span_name":a}),e.updateName(a)}else e.updateName(`${c} ${a.url}`)});e?await m(e):await d.withPropagatedContext(a.headers,()=>d.trace(k.BaseServerSpan.handleRequest,{spanName:`${c} ${a.url}`,kind:j.SpanKind.SERVER,attributes:{"http.method":c,"http.target":a.url}},m))}catch(a){if(p.isDev)throw a;(0,e.sendError)(b,500,"Internal Server Error")}finally{null==c.waitUntil||c.waitUntil.call(c,Promise.resolve())}}d()}catch(a){d(a)}})}};var b=require("../../../webpack-api-runtime.js");b.C(a);var c=b.X(0,[169],()=>b(b.s=9858));module.exports=c})();